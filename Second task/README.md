# Лабораторная работа № 2
## Задание
Разработать и реализовать программу для классификации изображений ладоней,
обеспечивающую:
- Ввод и отображение на экране изображений в формате TIF;
- Сегментацию изображений на основе точечных и пространственных
преобразований;
- Генерацию признаковых описаний формы ладоней на изображениях;
- Вычисление меры сходства ладоней;
- Кластеризацию изображений.

В качестве исходных данных прилагается набор из 99 цветных изображений ладоней
разных людей, полученных с помощью сканера, в формате 489×684 с разрешением 72 dpi.
Задача состоит в построении меры сходства изображений на основе выделения и анализа
формы ладоней. Нужно разработать и реализовать алгоритм, входом которого является
изображение, а выходом – описание признаков формы, попарные расстояния, кластеры
изображений.

Примеры входных изображений представлены на [рисунках](./training/).

В качестве признакового описания формы предлагается построить «линию пальцев» -
ломаную линию, соединяющую точки на кончиках пальцев (tips) с точками в основаниях
пальцев (valleys). Пример такой линии представлен на рисунке.
<br>![alt text](./Result_lines/006.tif_lines.jpg "Dozen_0.bmp")

## Решение
### Среда разработки
Решение производилось на языке Python, с ипользованием библиотек:
- [opencv](http://opencv.org/) для считывания, сохранения, отображения изображений, применения фильтров к изображениям, поиска контуров, построения выпуклой оболочки и поиска её дефектов.
- [numpy](http://www.numpy.org/) для хранения изображений.
- [sklearn](http://scikit-learn.org/) для кластеризации изображений.
- [pandas](http://pandas.pydata.org/) для вывода результатов кластеризации в формат csv.
- [matplotlib](http://matplotlib.org/) для отображения графиков при поиске оптимального числа кластеров. 

### Описание алгоритма
- Считываются изображения в чёрно-белом формате для применения фильтра и цветом формате для отображения полученных преобразований
- Применяется [фильтр для выделения границ ладони](./Edges/):  ![фильтр для выделения границ ладони](./Edges/find_edges_.tif_0.jpg "фильтр для выделения границ ладони")
- Выполняется [выделение всех границ на отфильтрованном изображении](./Contours_all/): ![выделение всех границ на отфильтрованном изображении](./Contours_all/001.tif_contours.jpg "выделение всех границ на отфильтрованном изображении")
- Производится отсев лишних границ:
  - Отбрасываются внешние контуры. 
  - Находится [контур ладони](./Contours_main/), как контур с наибольшей площадью из оставшихся. ![контур ладони](./Contours_main/001.tif_contours.jpg "контур ладони")
- По оставшемуся контуру строятся линии, соединяющие tips и valleys начиная с большого пальца:
  - Находится выпуклая оболочка для контура и её дефект.
  - Из точек дефекта удаляются:
    - Образующие с границей угол больший чем 90+\epsilon
    - Лежащие далеко от границ выпуклой оболочки.
    - на выходе остаются только четыре точки valleys.
  - Некоторые кончики пальцев в выпуклой оболочке описываются двумя точками. Для устранения этого недостатка берётся средняя точка между ними(предварительно точки упорядочиваются против часовой стрелки).
  - Произвожится сортировка точек tips и valleys против часовой стрелки.
  - Ищется порядок соответствующий минимальной сумме растояний между точками valleys и tips(по отдельности) соответствует расположению точек от большого пальца до мизинца. Таким образом точки valleys и tips упорядочены. По ним строятся [искомые линии](./Result_lines/). ![линии между valleys и tips](./Result_lines/001.tif_lines.jpg "линии между valleys и tips")
- Длины наиденных линии а также расстояния между точками valleys, в том числе и между последней и первой берутся в качестве признаков.
- Обучаются следующие алгоритмы кластеризации:
  - MiniBatchKMeans
  - KMeans
  - SpectralClustering
- число кластеров определяется по [графику](./Clustering/Graphs) функции score так чтоб убывание функции было достаточно маленьким. ![Определение числа кластеров](./Clustering/Graphs/MiniBatchKMeans.png "Определение числа кластеров")

### Результаты работы алгоритма
- На всём [датасете](./training/) алгоритм [находит линии](./Result_lines/) точно.
- В кластеры попадают визуально похожие руки, часто руки одного человека.

## Папки с промежуточными и финальными результатыми работы алгоритма
- [Фильтра для поиска границ ладони](./Edges/)
- [Все найденные контуры после применения фильтра](./Contours_all/)
- [Контуры ладони](./Contours_main/)
- [Линии между tips и valleys](./Result_lines/)
- [Кластеризация рук в формате (изображение, номер кластера)](./Clustering/)


